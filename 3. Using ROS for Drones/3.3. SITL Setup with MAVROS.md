# SITL Setup with MAVROS

This page follows the steps outlined [here](https://masoudir.github.io/mavros_tutorial/).

## 1. Setting up SITL

After building ArduCopter for SITL as outlined in [3.2. Building ArduPilot](./3.2.%20Building%20ArduPilot.md), you can run the vehicle by running the command
below, replacing the IP address with the IP address of your computer (in the
case of WSL, the IP of your WSL terminal). In a Linux environment, check your
IP using the `ifconfig` command.

```bash
$ sim_vehicle.py --out "172.29.4.129:14451"
```

**For older Linux versions, you might need to switch to `python3` to run this command**. See [1.2. Python
configuration](../1.%20Linux%20Setup/1.2.%20Python%20Configuration.md) for information on how to do this. But remember to switch
back - **ROS melodic runs on python2 at its core**.

* `sim_vehicle.py` is the script responsible for launching the vehicle. It also
launches MAVProxy during initialization.
* `--out "172.23.176.1:14451"` creates an additional output for other pieces of
software to connect to. By default, the vehicle can only be connected to via
`14450`. By creating another output, we can allow two software to connect to it,
such as **MissionPlanner** and our self-developed **autonomous-flight programme**.

The output of this command will have a line:
```bash
SIM_VEHICLE: "mavproxy.py" "--out" "172.29.0.1:14550" "--master" 
"tcp:127.0.0.1:5760" "--sitl" "127.0.0.1:5501" "--out" "172.29.4.129:14451"
```
*For some unknown reason, in the case above, `172.29.0.1:14550` can't be
connected but `172.29.4.129:14451` can. If we still want another connection,
we can just add an additional port like `172.29.4.129:14452`.*

## 2. Using MAVROS to connect to SITL

### Launch ROS
Now that a (simulated) drone is running, we want to setup ROS. In another
terminal, launch ROS with this command.
```bash
roscore
```

### Launch MAVROS
In another terminal, we run the following command to tell MAVROS where to find
the vehicle and connect to it. As always, make sure the IP address is changed
to whatever `--out` outputs of SITL.
```bash
$roslaunch mavros apm.launch fcu_url:=udp://172.29.4.129:14451@
```

### Check connection status
If running the command above did not result in an error, it is likely that
the connection is successful. You can check in another terminal by running
```bash
$ rostopic echo /mavros/state/connected
```
